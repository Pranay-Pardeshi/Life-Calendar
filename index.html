<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Diary - Your Name</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#5D8CAE">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

    <style>
        :root {
            /* TAKI THEME */
            --theme-color: #5D8CAE; 
            --theme-light: #EAF4F9;
            --text-main: #444444;
            --text-date: #5D8CAE;
            --text-sub: #666666;
            --bg-body: #F2F2F2;
            --bg-app: #FFFFFF;
            --border-color: rgba(0,0,0,0.1);
            --bottom-bar: #5D8CAE;
            --sky-bg: url('https://i.postimg.cc/jwDLn8Rf/Taki.png');
            --paper-bg: #fff;
            --input-bg: #fff;
            --anime-wallpaper: url('https://i.postimg.cc/jwDLn8Rf/Taki.png');
        }

        [data-theme="mitsuha"] {
            /* MITSUHA THEME */
            --theme-color: #FF6B6B;
            --theme-light: #FFF0F0;
            --text-date: #FF6B6B;
            --bottom-bar: #FF6B6B;
            --sky-bg: url('https://i.postimg.cc/BXHPCw2S/mitsuha.png');
            --anime-wallpaper: url('https://i.postimg.cc/BXHPCw2S/mitsuha.png');
        }

        [data-dark="true"] {
            /* DARK MODE OVERRIDES */
            --bg-body: #000000;
            --bg-app: #1C1C1E;
            --text-main: #FFFFFF;
            --text-sub: #A1A1A1;
            --border-color: rgba(255,255,255,0.15);
            --paper-bg: #2C2C2E;
            --input-bg: #2C2C2E;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            background-image: var(--anime-wallpaper);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background-color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: inherit;
            filter: blur(15px) brightness(0.7);
            z-index: -1;
            transform: scale(1.1);
        }

        #app-container {
            width: 100%; max-width: 450px; background-color: var(--bg-app);
            height: 100dvh; position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 100px rgba(0,0,0,0.5);
            transition: background-color 0.3s, max-width 0.3s, height 0.3s, border-radius 0.3s;
            z-index: 10;
        }

        @media (min-width: 450px) and (min-height: 600px) {
            #app-container {
                height: 90dvh;
                max-height: 850px;
                border-radius: 40px;
                border: 10px solid #333;
                margin: 20px;
            }
        }

        /* --- AUTH SYSTEM STYLES --- */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
            align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .auth-card {
            width: 90%; max-width: 380px; background: rgba(255, 255, 255, 0.9);
            padding: 40px 30px; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center; animation: authFadeIn 0.5s ease;
        }
        [data-dark="true"] .auth-card { background: rgba(30, 30, 30, 0.9); }
        @keyframes authFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .auth-logo { font-size: 2.5rem; color: var(--theme-color); margin-bottom: 10px; }
        .auth-title { font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin-bottom: 30px; }
        
        .auth-input-group { margin-bottom: 20px; text-align: left; }
        .auth-label { font-size: 12px; color: var(--theme-color); font-weight: 700; margin-bottom: 8px; display: block; }
        .auth-input {
            width: 100%; padding: 15px; border-radius: 12px; border: 1.5px solid var(--border-color);
            background: var(--input-bg); color: var(--text-main); font-size: 16px; outline: none;
        }
        .auth-input:focus { border-color: var(--theme-color); }

        .role-selector { display: flex; gap: 10px; margin-bottom: 25px; }
        .role-option {
            flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px;
            cursor: pointer; transition: 0.3s; font-weight: 600; color: var(--text-sub);
        }
        .role-option.selected[data-role="taki"] { border-color: #5D8CAE; color: #5D8CAE; background: #EAF4F9; }
        .role-option.selected[data-role="mitsuha"] { border-color: #FF6B6B; color: #FF6B6B; background: #FFF0F0; }

        .auth-btn {
            width: 100%; padding: 16px; border-radius: 15px; border: none;
            background: var(--theme-color); color: white; font-size: 17px; font-weight: 700;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .auth-btn:active { transform: scale(0.98); }
        .auth-switch { margin-top: 20px; font-size: 14px; color: var(--text-sub); cursor: pointer; }
        .auth-switch span { color: var(--theme-color); font-weight: 700; }

        /* --- ENTRANCE --- */
        #tear-off-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
        }
        .calendar-paper {
            width: 280px; height: 380px; background: #fff; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            text-align: center; transform-origin: top center; cursor: pointer; overflow: hidden;
            border-top: 12px solid #e0e0e0;
            border-radius: 2px;
        }
        .calendar-paper::before {
            content: ''; position: absolute; top: -12px; left: 0; width: 100%; height: 12px;
            background: radial-gradient(circle, #333 2px, transparent 2.5px);
            background-size: 15px 12px; opacity: 0.3;
        }
        .torn-off { animation: tearFall 0.8s forwards cubic-bezier(0.6, -0.28, 0.735, 0.045); pointer-events: none; }
        @keyframes tearFall {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-5deg) translateY(20px); }
            100% { transform: rotate(15deg) translateY(120vh); opacity: 0; }
        }
        .paper-header { padding: 18px; font-size: 1.3rem; font-weight: 500; color: #fff; background: var(--theme-color); text-transform: uppercase; letter-spacing: 3px; }
        .paper-body { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .paper-date-big { font-size: 8.5rem; font-weight: 700; color: #333; line-height: 1; letter-spacing: -5px; }
        .paper-day { font-size: 1.6rem; color: #888; margin-top: 10px; font-weight: 300; }
        .paper-hint { position: absolute; bottom: 25px; width: 100%; font-size: 0.9rem; color: #aaa; animation: blink 2s infinite; font-weight: 400; letter-spacing: 1px; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

        /* --- UI COMPONENTS --- */
        .status-bar {
            height: 44px; /* Taller for modern phones */
            background: var(--bg-app); display: flex; justify-content: space-between;
            align-items: center; padding: 0 20px; font-size: 13px; color: var(--text-main); font-weight: 600;
            border-bottom: 1px solid transparent; z-index: 20;
            padding-top: env(safe-area-inset-top); /* Notch support */
        }

        header {
            background: var(--bg-app); padding: 10px 15px 15px 15px;
            border-bottom: 1px solid var(--border-color); z-index: 10;
        }

        .segmented-control {
            display: flex; border: 1.5px solid var(--theme-color); border-radius: 8px;
            overflow: hidden; margin-bottom: 10px; height: 36px;
        }
        .segment {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: var(--theme-color); background: var(--bg-app); cursor: pointer;
            transition: 0.2s; border-right: 1.5px solid var(--theme-color); font-weight: 500;
        }
        .segment:last-child { border-right: none; }
        .segment.active { background: var(--theme-color); color: #fff; }
        
        .app-title {
            text-align: center; color: var(--theme-color); font-size: 19px;
            font-weight: 500; letter-spacing: 0.5px; margin-top: 8px; cursor: pointer;
        }

        .view-section {
            flex: 1; overflow-y: auto; display: none; background: var(--bg-app);
            position: relative;
            -webkit-overflow-scrolling: touch; /* Momentum scrolling */
        }
        .view-section.active { display: block; animation: fadeInView 0.4s ease; }
        @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ENTRY LIST (WITH SKY BG) --- */
        #view-entries.active {
            background-image: var(--sky-bg);
            background-size: cover;
            background-position: center;
            display: block;
        }

        .entry-list { padding-bottom: 20px; }

        .entry-item {
            display: flex; padding: 15px 18px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer; height: 100px;
            margin-bottom: 1px;
            transition: transform 0.2s, background 0.2s;
            animation: slideInItem 0.5s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        /* Staggered animation handled in JS or simplified CSS here */
        @keyframes slideInItem { to { opacity: 1; transform: translateY(0); } }

        [data-dark="true"] .entry-item {
            background: rgba(30, 30, 30, 0.85);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .entry-item:active { background: rgba(255,255,255,1); transform: scale(0.98); }
        [data-dark="true"] .entry-item:active { background: rgba(50,50,50,0.95); }

        .date-col {
            width: 55px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; margin-right: 18px; border-right: 1px solid rgba(0,0,0,0.1);
        }
        [data-dark="true"] .date-col { border-right: 1px solid rgba(255,255,255,0.1); }

        .date-num { font-size: 42px; color: var(--text-date); font-weight: 300; line-height: 1; letter-spacing: -2px; }
        .date-day { font-size: 12px; color: var(--text-sub); text-transform: capitalize; margin-top: 4px; font-weight: 500; }

        .content-col { flex: 1; display: flex; flex-direction: column; justify-content: center; position: relative; min-width: 0; }
        
        .meta-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .time { font-size: 12px; color: var(--theme-color); font-weight: 600; }
        .icons { display: flex; gap: 10px; color: var(--text-sub); font-size: 13px; }
        
        .entry-title {
            font-size: 17px; font-weight: 700; color: var(--text-main); margin-bottom: 5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .entry-excerpt {
            font-size: 13px; color: var(--text-sub); white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; opacity: 0.9;
        }
        .paperclip { position: absolute; right: 0; bottom: 5px; color: var(--theme-color); font-size: 16px; }

        /* --- CALENDAR --- */
        #view-calendar { padding: 25px; }
        .calendar-header { text-align: center; font-size: 20px; color: var(--theme-color); margin-bottom: 25px; font-weight: 300; letter-spacing: 1px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; text-align: center; }
        .cal-day-name { font-size: 12px; color: var(--text-sub); margin-bottom: 12px; font-weight: 600; opacity: 0.7; }
        .cal-date {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 15px; color: var(--text-main); border-radius: 50%; cursor: pointer; position: relative;
            transition: transform 0.2s, background 0.2s;
        }
        .cal-date:active { transform: scale(0.9); }
        .cal-date.has-entry { background-color: var(--theme-light); color: var(--theme-color); font-weight: 700; }
        [data-dark="true"] .cal-date.has-entry { background-color: rgba(93, 140, 174, 0.2); }
        [data-dark="true"][data-theme="mitsuha"] .cal-date.has-entry { background-color: rgba(255, 107, 107, 0.2); }

        .cal-date.has-entry::after {
            content: ''; position: absolute; bottom: 5px; width: 5px; height: 5px;
            background: var(--theme-color); border-radius: 50%;
        }
        .cal-date.is-today { border: 1.5px solid var(--theme-color); }

        /* --- DIARY EDITOR --- */
        #view-diary.active { display: flex; flex-direction: column; padding: 25px; height: 100%; }
        
        .editor-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .editor-options { display: flex; gap: 12px; }
        
        .option-btn {
            background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 12px;
            font-size: 14px; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .option-btn:active { transform: scale(0.95); }
        .option-btn.selected { background: var(--theme-color); color: #fff; border-color: var(--theme-color); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .editor-group { margin-bottom: 20px; }
        .editor-label { font-size: 12px; color: var(--theme-color); margin-bottom: 8px; font-weight: 700; display: block; letter-spacing: 0.5px; }
        
        .editor-input {
            width: 100%; padding: 15px; font-size: 17px; border: 1px solid var(--border-color);
            border-radius: 8px; outline: none; font-family: inherit; background: var(--input-bg); color: var(--text-main);
            transition: border 0.2s;
        }
        .editor-textarea {
            width: 100%; flex: 1; padding: 15px; font-size: 17px; border: 1px solid var(--border-color);
            border-radius: 8px; outline: none; resize: none; line-height: 1.6; font-family: inherit;
            min-height: 200px; background: var(--input-bg); color: var(--text-main);
            transition: border 0.2s;
        }
        .editor-input:focus, .editor-textarea:focus { border-color: var(--theme-color); }

        .image-preview {
            width: 100%; height: 180px; background: var(--bg-body); border: 1px dashed var(--text-sub);
            border-radius: 8px; display: none; align-items: center; justify-content: center;
            margin-bottom: 20px; overflow: hidden; position: relative;
        }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .remove-img { 
            position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); 
            color: #fff; border-radius: 50%; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .save-btn {
            background: var(--theme-color); color: white; border: none; padding: 16px;
            border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; margin-top: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;
        }
        .save-btn:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* --- BOTTOM BAR (Fixed for Mobile) --- */
        .bottom-bar {
            height: auto; /* Allow auto height */
            min-height: 60px; /* Taller touch target */
            background: var(--bottom-bar); 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 30px; 
            z-index: 50; /* Ensure on top */
            /* Crucial Mobile Fixes */
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); /* Shadow to separate */
        }
        .bar-icon { color: rgba(255,255,255,0.7); font-size: 24px; cursor: pointer; transition: 0.3s; }
        .bar-icon:hover { color: #fff; transform: translateY(-2px); }
        .bar-icon:active { transform: scale(0.9); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: flex-end;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.open { display: flex; animation: fadeInOverlay 0.3s ease; }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }

        .paper-sheet {
            width: 100%; height: 92%; max-width: 450px; background: var(--paper-bg);
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            display: flex; flex-direction: column; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        .sheet-header {
            padding: 20px; border-bottom: 1px solid var(--border-color); display: flex;
            justify-content: space-between; align-items: center; background: var(--bg-body);
            border-top-left-radius: 25px; border-top-right-radius: 25px;
        }
        .sheet-body { padding: 30px; flex: 1; overflow-y: auto; line-height: 1.8; color: var(--text-main); font-size: 16px; }
        .sheet-img { width: 100%; border-radius: 12px; margin-bottom: 20px; margin-top: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .close-btn { color: var(--theme-color); font-weight: 700; cursor: pointer; font-size: 17px; border: none; background: none; }
        .delete-btn { color: #ff4d4d; cursor: pointer; border: none; background: none; font-size: 18px; padding: 10px; }
        
        /* --- SETTINGS MENU --- */
        .settings-list { display: flex; flex-direction: column; padding: 25px; }
        .settings-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; border-bottom: 1px solid var(--border-color);
            cursor: pointer; color: var(--text-main); font-size: 16px; font-weight: 500;
        }
        .settings-item:last-child { border-bottom: none; }
        .profile-edit-wrapper {
            width: 90px; height: 90px; border-radius: 50%; margin: 0 auto;
            position: relative; cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .profile-edit-wrapper img {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--theme-color);
        }
        .edit-badge {
            position: absolute; bottom: 0; right: 0; background: var(--theme-color);
            color: #fff; width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .swapping { animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; filter: invert(10%); }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        
        /* --- SWITCH POPUP --- */
        .switch-popup {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 12px 25px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000;
            display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 14px;
            color: var(--theme-color); border: 2px solid var(--theme-color);
            pointer-events: none; opacity: 0;
            transition: opacity 0.5s;
        }
        [data-dark="true"] .switch-popup { background: rgba(30, 30, 30, 0.95); }
        .switch-popup.visible { animation: fadeInOut 5s forwards; }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }

        /* --- LOADING SPINNER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 99999;
            display: none; /* Hidden by default */
            align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: var(--theme-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #hidden-camera-input { display: none; }
        #hidden-pfp-input { display: none; }
    </style>
</head>
<body onload="initApp()">

<!-- LOADER -->
<div id="loader">
    <div class="spinner"></div>
</div>

<!-- AUTH OVERLAY -->
<div id="auth-overlay" class="auth-overlay" style="display:none;">
    <div class="auth-card">
        <div class="auth-logo"><i class="fas fa-meteor"></i></div>
        <div class="auth-title" id="auth-title">Welcome Back</div>
        
        <button class="auth-btn" id="google-signin-btn" onclick="signInWithGoogle()">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>
</div>

<!-- ROLE SELECTION MODAL (for new users) -->
<div id="role-selection-overlay" class="auth-overlay" style="display:none;">
    <div class="auth-card">
        <div class="auth-logo"><i class="fas fa-user-check"></i></div>
        <div class="auth-title">Choose Your Role</div>
        
        <p style="color: var(--text-sub); margin-bottom: 25px;">This choice is permanent and links you to your partner's diary.</p>

        <label class="auth-label">SELECT YOUR CHARACTER</label>
        <div class="role-selector">
            <div class="role-option selected" data-role="taki" onclick="selectRole('taki')">Taki</div>
            <div class="role-option" data-role="mitsuha" onclick="selectRole('mitsuha')">Mitsuha</div>
        </div>

        <button class="auth-btn" onclick="completeRegistration()">Confirm Role & Enter Diary</button>
    </div>
</div>

<!-- TEAR-OFF CALENDAR -->
<div id="tear-off-overlay">
    <div class="calendar-paper" onclick="tearPage(this)">
        <div class="paper-header" id="tear-month">OCTOBER</div>
        <div class="paper-body">
            <div class="paper-date-big" id="tear-date">12</div>
            <div class="paper-day" id="tear-day">Thursday</div>
        </div>
        <div class="paper-hint">Tap to Open</div>
    </div>
</div>

<div id="app-container">
    <div class="status-bar">
        <span id="status-date" style="font-weight: 500;">Oct 12</span>
        <span id="clock" style="font-weight:600;">12:00</span>
        <span style="width: 40px;"></span> 
    </div>

    <div id="switch-popup" class="switch-popup">
        <i class="fas fa-history"></i>
        <span id="switch-msg">Timeline shift in -- hours</span>
    </div>

    <header>
        <div class="segmented-control">
            <div class="segment active" onclick="switchTab('entries')">Entries</div>
            <div class="segment" onclick="switchTab('calendar')">Calendar</div>
            <div class="segment" onclick="switchTab('diary')">Diary</div>
        </div>
        <div class="app-title">Diary</div>
    </header>

    <!-- VIEW 1: ENTRIES -->
    <div class="view-section active" id="view-entries">
        <div class="entry-list" id="entry-list-container"></div>
    </div>

    <!-- VIEW 2: CALENDAR -->
    <div class="view-section" id="view-calendar">
        <div class="calendar-header" id="cal-main-header">October 2013</div>
        <div class="calendar-grid" id="calendar-grid-container"></div>
    </div>

    <!-- VIEW 3: DIARY (EDITOR) -->
    <div class="view-section" id="view-diary">
        <div class="editor-header">
            <div class="editor-options">
                <button class="option-btn selected" onclick="setMood(this, 'sun')"><i class="fas fa-sun"></i></button>
                <button class="option-btn" onclick="setMood(this, 'cloud')"><i class="fas fa-cloud"></i></button>
                <button class="option-btn" onclick="setMood(this, 'cloud-rain')"><i class="fas fa-cloud-rain"></i></button>
                <button class="option-btn" onclick="setMood(this, 'moon')"><i class="fas fa-moon"></i></button>
            </div>
            <div class="editor-options">
                <button class="option-btn" onclick="triggerCamera()"><i class="fas fa-camera"></i> Photo</button>
            </div>
        </div>

        <div class="image-preview" id="editor-img-preview">
            <div class="remove-img" onclick="clearImage()">&times;</div>
            <img src="" id="preview-img-tag">
        </div>

        <div class="editor-group">
            <label class="editor-label">TITLE</label>
            <input type="text" class="editor-input" id="new-title" placeholder="e.g., Tokyo Cafe">
        </div>
        
        <div class="editor-group" style="flex:1; display:flex; flex-direction:column;">
            <label class="editor-label">CONTENT</label>
            <textarea class="editor-textarea" id="new-content" placeholder="What happened today?"></textarea>
        </div>
        
        <button class="save-btn" onclick="saveNewEntry()">Save Entry</button>
    </div>

    <!-- BOTTOM BAR -->
    <div class="bottom-bar">
        <i class="fas fa-bars bar-icon" onclick="openSettings()"></i>
        <i class="fas fa-pen bar-icon" onclick="switchTab('diary')"></i>
        <i class="fas fa-camera bar-icon" onclick="triggerCamera()"></i>
    </div>

    <!-- HIDDEN INPUTS -->
    <input type="file" id="hidden-camera-input" accept="image/*" onchange="handleFileSelect(this)">
    <input type="file" id="hidden-pfp-input" accept="image/*" onchange="handlePfpSelect(this)">

</div>

<!-- READ MODAL -->
<div class="modal-overlay" id="modal">
    <div class="paper-sheet">
        <div class="sheet-header">
            <!-- Delete button added here -->
            <button class="delete-btn" onclick="deleteCurrentEntry()"><i class="fas fa-trash"></i></button>
            <span style="font-size:14px; color:var(--text-sub);" id="m-date">Date</span>
            <button class="close-btn" onclick="closeModal()">Done</button>
        </div>
        <div class="sheet-body">
            <img id="m-img" class="sheet-img" style="display:none;">
            <h2 id="m-title" style="margin-bottom: 15px; color: var(--theme-color);">Title</h2>
            <div id="m-text" style="white-space: pre-wrap;">Content...</div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
    <div class="paper-sheet" style="height: auto; max-height: 80%; border-radius: 20px; margin: 20px;">
        <div class="sheet-header">
            <span style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">Settings</span>
            <button class="close-btn" onclick="closeSettings()">Close</button>
        </div>
        <div class="sheet-body" style="padding: 0;">
            <!-- Profile Section -->
            <div style="text-align:center; padding: 30px; border-bottom: 1px solid var(--border-color);">
                <div class="profile-edit-wrapper" onclick="triggerPfpUpload()">
                    <img id="settings-pfp" src="https://i.pinimg.com/736x/2e/0f/20/2e0f2095037d0563457a4128f7311756.jpg">
                    <div class="edit-badge"><i class="fas fa-camera"></i></div>
                </div>
                <p id="settings-profile-username" style="margin-top:15px; font-weight:bold; color: var(--text-main); font-size: 1.1rem;">My Profile</p>
            </div>
            <!-- Settings List -->
            <div class="settings-list">
                <div class="settings-item">
                    <span>Logged in as</span>
                    <span id="logged-in-username" style="color:var(--theme-color); font-weight:bold;">Loading...</span>
                </div>
                <div class="settings-item" onclick="toggleDarkMode()">
                    <span>Dark Mode</span>
                    <i class="fas fa-moon" id="dark-mode-icon"></i>
                </div>
                <div class="settings-item" onclick="handleLogout()" style="border-top: 1px solid var(--border-color); margin-top: 20px;">
                    <span style="color:#ff4d4d">Logout</span>
                    <i class="fas fa-sign-out-alt" style="color:#ff4d4d"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyD40csyp5CtEHzwzv6QXCsjwKZXCf7guls",
        authDomain: "jarvis-website-sign-in-feature.firebaseapp.com",
        projectId: "jarvis-website-sign-in-feature",
        storageBucket: "jarvis-website-sign-in-feature.firebasestorage.app",
        messagingSenderId: "88057670607",
        appId: "1:88057670607:web:8a4448a53451cde24dc0ba",
        measurementId: "G-V04D48SN7P"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.analytics(); // Initialize analytics
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // --- APP STATE ---
    let entries = [];
    let currentUser = null;
    let userProfile = null;
    let authMode = 'login'; 
    let selectedRole = 'taki';
    let currentMood = "sun";
    let currentImageFile = null; // This will hold the actual file for uploads
    let currentEntryIndex = -1;
    let isMitsuha = false;
    let isDark = false;

    // --- LOADER & TIME HELPERS ---
    function showLoader() { document.getElementById('loader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    
    function getISTDate() {
        const now = new Date();
        const istOffset = 5.5 * 60 * 60 * 1000;
        return new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + istOffset);
    }

    function showSwitchPopup() {
        const istNow = getISTDate();
        const nextSwitch = new Date(istNow);
        nextSwitch.setHours(24, 0, 0, 0);
        const diffMs = nextSwitch - istNow;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        
        const msg = diffHours > 0 ? 
            `Timeline shift in ${diffHours} hours` : 
            `Timeline shift in ${diffMins} minutes`;
            
        const popup = document.getElementById('switch-popup');
        document.getElementById('switch-msg').innerText = msg;
        popup.classList.add('visible');
    }

    function showWelcomeToast(isEvenDay, ownRole, viewRole) {
        if (ownRole === viewRole) return; // Don't show if viewing own diary

        const msg = `It's an ${isEvenDay ? 'even' : 'odd'} day. You're seeing ${viewRole}'s diary.`;
        const welcomePopup = document.createElement('div');
        welcomePopup.className = 'switch-popup visible';
        welcomePopup.style.top = '180px'; // Position below the other popup
        welcomePopup.innerHTML = `<i class="fas fa-random"></i><span>${msg}</span>`;
        document.getElementById('app-container').appendChild(welcomePopup);
        setTimeout(() => welcomePopup.remove(), 5000);
    }

    // --- AUTH LOGIC ---
    function initApp() {
        initTearOff();
        showSwitchPopup();
        showLoader();
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // Check if user has a profile in Firestore
                const userDocRef = db.collection('users').doc(user.uid);
                const doc = await userDocRef.get();

                if (doc.exists) {
                    // User exists, fetch profile and load app
                    await fetchUserProfile();
                } else {
                    // New user, show role selection
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('role-selection-overlay').style.display = 'flex';
                    hideLoader();
                }
            } else {
                // No user logged in
                showAuthOverlay();
                hideLoader();
            }
        });
    }

    async function signInWithGoogle() {
        showLoader();
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await auth.signInWithPopup(provider);
            // onAuthStateChanged will handle the rest
        } catch (error) {
            alert(error.message);
            hideLoader();
        }
    }

    async function completeRegistration() {
        if (!currentUser) return;
        showLoader();

        const profile = {
            uid: currentUser.uid,
            username: currentUser.displayName,
            email: currentUser.email,
            avatarUrl: currentUser.photoURL || '',
            role: selectedRole,
        };

        try {
            await db.collection('users').doc(currentUser.uid).set(profile);
            document.getElementById('role-selection-overlay').style.display = 'none';
            await fetchUserProfile(); // Fetch the newly created profile
        } catch (error) {
            alert(error.message);
            hideLoader();
        }
    }

    async function fetchUserProfile() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                userProfile = doc.data();
                document.getElementById('settings-pfp').src = userProfile.avatarUrl || 'https://i.pinimg.com/originals/2e/0f/20/2e0f2095037d0563457a4128f7311756.jpg';
                hideAuthOverlay();
                await loadEntries();
                displayLoggedInUser();
            } else {
                // This case should ideally not be hit with the new flow
                auth.signOut();
            }
        } catch(err) {
            console.error(err);
            alert("Could not fetch user profile.");
            hideLoader();
        }
    }

    function displayLoggedInUser() {
        const usernameEl = document.getElementById('logged-in-username');
        if (usernameEl && userProfile && userProfile.username) {
            usernameEl.innerText = userProfile.username;
        }
        const profileNameEl = document.getElementById('settings-profile-username');
        if (profileNameEl && userProfile && userProfile.username) {
            profileNameEl.innerText = userProfile.username;
        }
    }

    function showAuthOverlay() {
        document.getElementById('auth-overlay').style.display = 'flex';
    }

    function hideAuthOverlay() {
        document.getElementById('auth-overlay').style.display = 'none';
    }

    function selectRole(role) {
        selectedRole = role;
        document.querySelectorAll('.role-option').forEach(opt => {
            opt.classList.toggle('selected', opt.getAttribute('data-role') === role);
        });
    }

    async function handleLogout() {
        showLoader();
        try {
            await auth.signOut();
            window.location.reload();
        } catch(err) {
            alert("Could not log out.");
            hideLoader();
        }
    }

    // --- DATA HANDLING ---
    async function loadEntries() {
        if (!userProfile) {
            hideLoader();
            return;
        }

        const istNow = getISTDate();
        const today = istNow.getDate();
        const isEvenDay = today % 2 === 0;

        let displayRole;
        if (userProfile.role === 'taki') {
            displayRole = isEvenDay ? 'taki' : 'mitsuha';
        } else {
            displayRole = isEvenDay ? 'mitsuha' : 'taki';
        }

        isMitsuha = (displayRole === 'mitsuha');
        updateTheme();
        showWelcomeToast(isEvenDay, userProfile.role, displayRole);
        
        try {
            const snapshot = await db.collection('entries')
                .where('author_role', '==', displayRole)
                .orderBy('timestamp', 'desc')
                .get();

            entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error("Error loading entries:", error);
            if (error.code === 'failed-precondition') {
                console.warn("QUERY REQUIRES INDEX: A composite index is needed for this query to work efficiently. Please create it in your Firebase console. The link to create it should be in the error message in your browser's developer console.");
            }
            const snapshot = await db.collection('entries')
                .where('author_role', '==', displayRole)
                .get();
            entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        } finally {
            renderEntries();
            renderCalendar();
            hideLoader();
        }
    }

    function initTearOff() {
        const istNow = getISTDate();
        const months = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        document.getElementById('tear-month').innerText = months[istNow.getMonth()];
        document.getElementById('tear-date').innerText = istNow.getDate();
        document.getElementById('tear-day').innerText = days[istNow.getDay()];
        document.getElementById('status-date').innerText = `${months[istNow.getMonth()].substring(0,3)} ${istNow.getDate()}`;
        document.getElementById('cal-main-header').innerText = `${months[istNow.getMonth()]} ${istNow.getFullYear()}`;
    }

    function tearPage(el) {
        el.classList.add('torn-off');
        setTimeout(() => document.getElementById('tear-off-overlay').style.display='none', 800);
    }

    // --- RENDER ---
    function renderEntries() {
        const list = document.getElementById('entry-list-container');
        list.innerHTML = '';
        
        if (entries.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:50px; color:rgba(255,255,255,0.7); font-style:italic;">
                No ${isMitsuha ? "Mitsuha's" : "Taki's"} entries yet...
            </div>`;
            return;
        }

        entries.forEach((e, idx) => {
            let iconClass = "fa-sun";
            if(e.weather === 'cloud-rain') iconClass = "fa-cloud-rain";
            else if(e.weather === 'cloud') iconClass = "fa-cloud";
            else if(e.weather === 'moon') iconClass = "fa-moon";

            const hasImg = e.image ? '<i class="fas fa-image" style="margin-right:5px"></i>' : '';
            const delay = idx * 0.1;

            const html = `
            <div class="entry-item" onclick="openModal(${idx})" style="animation-delay: ${delay}s">
                <div class="date-col">
                    <span class="date-num">${e.date}</span>
                    <span class="date-day">${e.day}</span>
                </div>
                <div class="content-col">
                    <div class="meta-row">
                        <span class="time">${e.time}</span>
                        <div class="icons">
                            ${hasImg}
                            <i class="fas ${iconClass}"></i>
                            <i class="far fa-smile"></i>
                        </div>
                    </div>
                    <div class="entry-title">${e.title}</div>
                    <div class="entry-excerpt">${e.preview}</div>
                    <i class="fas fa-paperclip paperclip"></i>
                </div>
            </div>`;
            list.innerHTML += html;
        });
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid-container');
        grid.innerHTML = '';
        ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d => grid.innerHTML+=`<div class="cal-day-name">${d}</div>`);
        
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`; 
        
        for(let i=1; i<=daysInMonth; i++) {
            const hasEntry = entries.some(e => parseInt(e.date) === i);
            const isToday = (i === now.getDate());
            const cls = `${hasEntry?'has-entry':''} ${isToday?'is-today':''}`;
            const act = hasEntry ? `onclick="openEntryByDate(${i})"` : '';
            grid.innerHTML += `<div class="cal-date ${cls}" ${act}>${i}</div>`;
        }
    }

    // --- NAVIGATION ---
    function switchTab(name) {
        document.querySelectorAll('.segment').forEach(el => el.classList.remove('active'));
        const idx = {'entries':0, 'calendar':1, 'diary':2}[name];
        document.querySelectorAll('.segment')[idx].classList.add('active');
        
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${name}`).classList.add('active');
        
        if(name === 'entries') renderEntries();
        if(name === 'calendar') renderCalendar();
    }

    // --- EDITOR LOGIC ---
    function setMood(btn, mood) {
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentMood = mood;
    }

    function triggerCamera() {
        document.getElementById('hidden-camera-input').click();
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            currentImageFile = file; // Store the file object

            // Use FileReader to show a preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img-tag').src = e.target.result;
                document.getElementById('editor-img-preview').style.display = 'flex';
                switchTab('diary');
            };
            reader.readAsDataURL(file);
        }
    }

    function clearImage() {
        currentImageFile = null;
        document.getElementById('editor-img-preview').style.display = 'none';
        document.getElementById('hidden-camera-input').value = '';
    }

    async function saveNewEntry() {
        if (!currentUser) return;
        const title = document.getElementById('new-title').value;
        const content = document.getElementById('new-content').value;
        if(!title || !content) { alert("Please write something!"); return; }

        showLoader();

        const now = new Date();
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        
        let imageUrl = null;

        try {
            if (currentImageFile) {
                const filePath = `diary_images/${currentUser.uid}/${Date.now()}_${currentImageFile.name}`;
                const fileRef = storage.ref(filePath);
                await fileRef.put(currentImageFile);
                imageUrl = await fileRef.getDownloadURL();
            }

            const newEntry = {
                author_uid: currentUser.uid,
                author_role: userProfile.role,
                date: String(now.getDate()),
                day: days[now.getDay()],
                time: `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
                month: months[now.getMonth()],
                title: title,
                preview: content.substring(0, 50) + "...",
                full: content,
                weather: currentMood,
                image: imageUrl,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('entries').add(newEntry);
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-content').value = '';
            clearImage();
            switchTab('entries');
            await loadEntries();
        } catch (error) {
            alert("Error saving entry: " + error.message);
        } finally {
            hideLoader(); // Ensure loader is always hidden
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    // --- MODAL & DELETE ---
    function openModal(idx) { 
        currentEntryIndex = idx;
        fillModal(entries[idx]); 
    }
    
    function openEntryByDate(d) {
        const idx = entries.findIndex(x => parseInt(x.date) === d);
        if(idx !== -1) {
            currentEntryIndex = idx;
            fillModal(entries[idx]);
        }
    }
    
    function fillModal(e) {
        document.getElementById('m-title').innerText = e.title;
        document.getElementById('m-text').innerText = e.full;
        document.getElementById('m-date').innerText = `${e.day}, ${e.month} ${e.date}`;
        
        const imgEl = document.getElementById('m-img');
        if(e.image) {
            imgEl.src = e.image;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }
        
        document.querySelector('.delete-btn').style.visibility = (e.author_uid === currentUser.uid) ? 'visible' : 'hidden';
        
        document.getElementById('modal').classList.add('open');
    }
    
    function closeModal() { document.getElementById('modal').classList.remove('open'); }

    async function deleteCurrentEntry() {
        const entry = entries[currentEntryIndex];
        if (entry.author_uid !== currentUser.uid) {
            alert("You can only delete your own entries!");
            return;
        }

        if(confirm("Delete this entry?")) {
            showLoader();
            try {
                if (entry.image) {
                    try {
                        const imageRef = storage.refFromURL(entry.image);
                        await imageRef.delete();
                    } catch (storageError) {
                        console.error("Could not delete image from storage, it might not exist.", storageError);
                    }
                }
                await db.collection('entries').doc(entry.id).delete();
                closeModal();
                await loadEntries();
            } catch (error) {
                alert("Error deleting entry: " + error.message);
            } finally {
                hideLoader();
            }
        }
    }

    // --- SETTINGS & PROFILE ---
    function openSettings() {
        document.getElementById('settings-modal').classList.add('open');
    }
    function closeSettings() {
        document.getElementById('settings-modal').classList.remove('open');
    }

    function triggerPfpUpload() {
        document.getElementById('hidden-pfp-input').click();
    }

    async function handlePfpSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            showLoader();
            try {
                // Upload for logged-in users
                const filePath = `avatars/${currentUser.uid}/${file.name}`;
                const fileRef = storage.ref(filePath);
                await fileRef.put(file);
                const avatarUrl = await fileRef.getDownloadURL();

                await db.collection('users').doc(currentUser.uid).update({ avatarUrl });
                document.getElementById('settings-pfp').src = avatarUrl;
                hideLoader();
            } catch (error) {
                alert("Error uploading profile picture.");
                hideLoader();
            }
        }
    }

    // --- THEME ---
    function updateTheme() {
        const root = document.documentElement;
        const label = document.getElementById('theme-label');
        if(isMitsuha) {
            root.setAttribute('data-theme', 'mitsuha');
            if(label) {
                label.innerText = "Mitsuha (Pink)";
                label.style.color = "#FF6B6B";
            }
        } else {
            root.removeAttribute('data-theme');
            if(label) {
                label.innerText = "Taki (Blue)";
                label.style.color = "#5D8CAE";
            }
        }
    }

    function toggleDarkMode() {
        isDark = !isDark;
        const root = document.documentElement;
        const icon = document.getElementById('dark-mode-icon');
        if(isDark) {
            root.setAttribute('data-dark', 'true');
            icon.className = "fas fa-sun";
        } else {
            root.removeAttribute('data-dark');
            icon.className = "fas fa-moon";
        }
    }

    // --- CLOCK ---
    setInterval(() => {
        const now = new Date();
        const clockEl = document.getElementById('clock');
        if (clockEl) {
            clockEl.innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        }
    }, 1000);

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
</script>

</body>
</html>
